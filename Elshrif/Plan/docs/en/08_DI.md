# üíâ Dependency Injection (`di.xml`)

> Complete Guide to DI in Magento 2

---

## üìë Table of Contents

1. [Introduction](#1-introduction)
2. [File Location](#2-file-location)
3. [Preferences](#3-preferences)
4. [Type Configuration](#4-type-configuration)
5. [Virtual Types](#5-virtual-types)
6. [Arguments](#6-arguments)
7. [Plugins](#7-plugins)
8. [Factories & Proxies](#8-factories--proxies)
9. [Best Practices](#9-best-practices)

---

## 1. Introduction

### What is Dependency Injection?

DI is a pattern that allows **injecting** dependencies instead of creating them internally.

```php
// ‚ùå Without DI - Tight coupling
class MyClass
{
    public function doSomething()
    {
        $logger = new \Monolog\Logger();
    }
}

// ‚úÖ With DI - Loose coupling
class MyClass
{
    public function __construct(
        private LoggerInterface $logger
    ) {}
}
```

---

## 2. File Location

```
app/code/Vendor/Module/etc/
‚îú‚îÄ‚îÄ di.xml                    # Global (all areas)
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ di.xml                # Frontend only
‚îî‚îÄ‚îÄ adminhtml/
    ‚îî‚îÄ‚îÄ di.xml                # Admin only
```

---

## 3. Preferences

Bind Interface to Implementation:

```xml
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <preference for="Vendor\Module\Api\EntityRepositoryInterface"
                type="Vendor\Module\Model\EntityRepository"/>
</config>
```

---

## 4. Type Configuration

### Define Arguments

```xml
<type name="Vendor\Module\Model\MyClass">
    <arguments>
        <argument name="text" xsi:type="string">Hello World</argument>
        <argument name="count" xsi:type="number">100</argument>
        <argument name="enabled" xsi:type="boolean">true</argument>
        <argument name="helper" xsi:type="object">Vendor\Module\Helper\Data</argument>
        <argument name="items" xsi:type="array">
            <item name="key1" xsi:type="string">value1</item>
        </argument>
    </arguments>
</type>
```

---

## 5. Virtual Types

A Virtual Type is a class that exists only in configuration:

```xml
<virtualType name="Vendor\Module\Logger\Handler"
             type="Magento\Framework\Logger\Handler\Base">
    <arguments>
        <argument name="fileName" xsi:type="string">/var/log/vendor_module.log</argument>
    </arguments>
</virtualType>

<virtualType name="Vendor\Module\Logger\Logger"
             type="Magento\Framework\Logger\Monolog">
    <arguments>
        <argument name="name" xsi:type="string">vendor_module</argument>
        <argument name="handlers" xsi:type="array">
            <item name="system" xsi:type="object">Vendor\Module\Logger\Handler</item>
        </argument>
    </arguments>
</virtualType>

<type name="Vendor\Module\Model\MyClass">
    <arguments>
        <argument name="logger" xsi:type="object">Vendor\Module\Logger\Logger</argument>
    </arguments>
</type>
```

---

## 6. Arguments

### Argument Types

| Type | Example |
|------|---------|
| `string` | `"text value"` |
| `number` | `100` |
| `boolean` | `true` / `false` |
| `object` | Class name |
| `array` | Nested items |
| `null` | null value |
| `const` | Class constant |

### Shared Argument

```xml
<!-- shared="true" (default) - Singleton -->
<argument name="obj" xsi:type="object">Vendor\Module\Model\Item</argument>

<!-- shared="false" - New instance each time -->
<argument name="obj" xsi:type="object" shared="false">Vendor\Module\Model\Item</argument>
```

---

## 7. Plugins

### Define Plugin

```xml
<type name="Magento\Catalog\Model\Product">
    <plugin name="vendor_module_product_plugin"
            type="Vendor\Module\Plugin\ProductPlugin"
            sortOrder="10"
            disabled="false"/>
</type>
```

### Plugin Class

```php
class ProductPlugin
{
    public function beforeGetName(Product $subject): array
    {
        return [];  // Return array of modified arguments
    }

    public function afterGetName(Product $subject, string $result): string
    {
        return $result . ' - Modified';
    }

    public function aroundGetName(Product $subject, callable $proceed): string
    {
        // Before
        $result = $proceed();
        // After
        return $result;
    }
}
```

---

## 8. Factories & Proxies

### Factories

Create new instances:

```php
public function __construct(
    private \Vendor\Module\Model\EntityFactory $entityFactory
) {}

public function createEntity(): Entity
{
    return $this->entityFactory->create();
}
```

### Proxies

Lazy loading for heavy dependencies:

```xml
<type name="Vendor\Module\Command\MyCommand">
    <arguments>
        <argument name="session" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
    </arguments>
</type>
```

---

## 9. Best Practices

### ‚úÖ Use Interfaces

```xml
<preference for="Vendor\Module\Api\ServiceInterface"
            type="Vendor\Module\Model\Service"/>
```

### ‚úÖ Use Plugins Instead of Preferences

```xml
<!-- ‚úÖ Better - doesn't replace the class -->
<plugin name="my_plugin" type="Vendor\Module\Plugin\ProductPlugin"/>

<!-- ‚ùå Risky - full replacement -->
<preference for="Magento\Catalog\Model\Product" type="..."/>
```

### ‚úÖ Use Area-specific di.xml

```
etc/frontend/di.xml  ‚Üê Frontend only
etc/adminhtml/di.xml ‚Üê Admin only
```

---

## üìå Summary

| Element | Purpose |
|---------|---------|
| `<preference>` | Interface ‚Üí Implementation |
| `<type>` | Configure class arguments |
| `<virtualType>` | Virtual class |
| `<plugin>` | Before/After/Around methods |

---

## ‚¨ÖÔ∏è [Previous](./07_VIEWS.md) | [üè† Home](../MODULE_STRUCTURE_EN.md) | [Next ‚û°Ô∏è](./09_OBSERVERS.md)
