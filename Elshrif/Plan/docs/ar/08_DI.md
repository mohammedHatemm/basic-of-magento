# ğŸ’‰ Dependency Injection (`di.xml`)

> Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ù€ DI ÙÙŠ Magento 2

---

## ğŸ“‘ Ø§Ù„ÙÙ‡Ø±Ø³

1. [Ù…Ù‚Ø¯Ù…Ø©](#1-Ù…Ù‚Ø¯Ù…Ø©)
2. [Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù„Ù](#2-Ù…ÙˆÙ‚Ø¹-Ø§Ù„Ù…Ù„Ù)
3. [XSD Schema](#3-xsd-schema)
4. [Preferences](#4-preferences)
5. [Type Configuration](#5-type-configuration)
6. [Virtual Types](#6-virtual-types)
7. [Arguments](#7-arguments)
8. [Plugins](#8-plugins)
9. [Factories](#9-factories)
10. [Proxies](#10-proxies)
11. [Best Practices](#11-best-practices)
12. [Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙ‚Ø¯Ù…](#12-Ù…Ø³ØªÙˆÙ‰-Ù…ØªÙ‚Ø¯Ù…)

---

## 1. Ù…Ù‚Ø¯Ù…Ø©

### Ù…Ø§ Ù‡Ùˆ Dependency InjectionØŸ

**DI** Ù‡Ùˆ pattern ÙŠØ³Ù…Ø­ Ø¨Ù€ **inject** Ø§Ù„Ù€ dependencies Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¦Ù‡Ø§ Ø¯Ø§Ø®Ù„ÙŠØ§Ù‹.

```php
// âŒ Ø¨Ø¯ÙˆÙ† DI - Tight coupling
class MyClass
{
    public function doSomething()
    {
        $logger = new \Monolog\Logger();  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¨Ø§Ø´Ø±
        $logger->info('message');
    }
}

// âœ… Ù…Ø¹ DI - Loose coupling
class MyClass
{
    public function __construct(
        private LoggerInterface $logger  // Injected
    ) {}

    public function doSomething()
    {
        $this->logger->info('message');
    }
}
```

### ObjectManager

```php
// Ø§Ù„Ù€ ObjectManager Ù‡Ùˆ Ø§Ù„Ù€ DI Container ÙÙŠ Magento
Magento\Framework\ObjectManagerInterface

// ÙŠÙ…ÙƒÙ†Ù‡:
// - Ø¥Ù†Ø´Ø§Ø¡ Objects
// - Inject Dependencies
// - Ø¥Ø¯Ø§Ø±Ø© Singletons
// - ØªØ·Ø¨ÙŠÙ‚ Preferences
```

---

## 2. Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù„Ù

```
app/code/Vendor/Module/etc/
â”œâ”€â”€ di.xml                    # Global (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ areas)
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ di.xml                # Frontend ÙÙ‚Ø·
â”œâ”€â”€ adminhtml/
â”‚   â””â”€â”€ di.xml                # Admin ÙÙ‚Ø·
â”œâ”€â”€ webapi_rest/
â”‚   â””â”€â”€ di.xml                # REST API ÙÙ‚Ø·
â”œâ”€â”€ webapi_soap/
â”‚   â””â”€â”€ di.xml                # SOAP API ÙÙ‚Ø·
â”œâ”€â”€ graphql/
â”‚   â””â”€â”€ di.xml                # GraphQL ÙÙ‚Ø·
â””â”€â”€ crontab/
    â””â”€â”€ di.xml                # Cron ÙÙ‚Ø·
```

### ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ­Ù…ÙŠÙ„

```
1. vendor/magento/*/etc/di.xml (Ø§Ù„Ø£ÙˆÙ„)
2. app/code/Vendor/Module/etc/di.xml
3. app/code/Vendor/Module/etc/{area}/di.xml (Ø§Ù„Ø£Ø®ÙŠØ± - ÙŠÙÙˆØ²)
```

---

## 3. XSD Schema

### Schema Location

```xml
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">
```

### Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©

| Element | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|---------|---------|
| `<preference>` | Ø±Ø¨Ø· Interface Ø¨Ù€ Implementation |
| `<type>` | ØªÙƒÙˆÙŠÙ† Class |
| `<virtualType>` | Class ÙˆÙ‡Ù…ÙŠ |
| `<plugin>` | Ø¥Ø¶Ø§ÙØ© Plugin |

---

## 4. Preferences

### Ù…Ø§ Ù‡Ùˆ PreferenceØŸ

Ø±Ø¨Ø· Interface Ø¨Ù€ Implementation Ø§Ù„ÙØ¹Ù„ÙŠ.

```xml
<config>
    <preference for="Vendor\Module\Api\EntityRepositoryInterface"
                type="Vendor\Module\Model\EntityRepository"/>
</config>
```

### ÙƒÙŠÙ ÙŠØ¹Ù…Ù„

```php
// Ø¹Ù†Ø¯ Ø·Ù„Ø¨ Interface
public function __construct(
    Vendor\Module\Api\EntityRepositoryInterface $repository
) {}

// Magento ÙŠÙÙ†Ø´Ø¦ Implementation
new Vendor\Module\Model\EntityRepository()
```

### Override Core Class

```xml
<!-- Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Product Model -->
<preference for="Magento\Catalog\Model\Product"
            type="Vendor\Module\Model\Product"/>
```

> âš ï¸ **ØªØ­Ø°ÙŠØ±:** ØªØ¬Ù†Ø¨ Override Ù„Ù„Ù€ Core classes. Ø§Ø³ØªØ®Ø¯Ù… **Plugins** Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù†Ù‡Ø§.

---

## 5. Type Configuration

### ØªØ¹Ø±ÙŠÙ Arguments

```xml
<type name="Vendor\Module\Model\MyClass">
    <arguments>
        <argument name="paramName" xsi:type="string">value</argument>
    </arguments>
</type>
```

### Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù€ Arguments

```xml
<type name="Vendor\Module\Model\Example">
    <arguments>
        <!-- String -->
        <argument name="text" xsi:type="string">Hello World</argument>

        <!-- Number -->
        <argument name="count" xsi:type="number">100</argument>

        <!-- Boolean -->
        <argument name="enabled" xsi:type="boolean">true</argument>

        <!-- Null -->
        <argument name="optional" xsi:type="null"/>

        <!-- Object -->
        <argument name="helper" xsi:type="object">Vendor\Module\Helper\Data</argument>

        <!-- Object with shared="false" (new instance) -->
        <argument name="model" xsi:type="object" shared="false">Vendor\Module\Model\Entity</argument>

        <!-- Array -->
        <argument name="items" xsi:type="array">
            <item name="key1" xsi:type="string">value1</item>
            <item name="key2" xsi:type="number">100</item>
            <item name="key3" xsi:type="object">Vendor\Module\Model\Item</item>
            <item name="nested" xsi:type="array">
                <item name="subkey" xsi:type="string">subvalue</item>
            </item>
        </argument>

        <!-- Constant -->
        <argument name="status" xsi:type="const">Vendor\Module\Model\Entity::STATUS_ACTIVE</argument>

        <!-- Init Parameter -->
        <argument name="data" xsi:type="init_parameter">Vendor\Module\Model\Entity::class</argument>
    </arguments>
</type>
```

### Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ PHP

```php
class Example
{
    public function __construct(
        private string $text,           // "Hello World"
        private int $count,             // 100
        private bool $enabled,          // true
        private ?object $optional,      // null
        private HelperData $helper,     // Helper instance
        private Entity $model,          // Entity instance
        private array $items,           // Array
        private int $status             // Constant value
    ) {}
}
```

---

## 6. Virtual Types

### Ù…Ø§ Ù‡Ùˆ Virtual TypeØŸ

Class ÙˆÙ‡Ù…ÙŠ - Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ configuration ÙÙ‚Ø·ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ PHP file.

```xml
<virtualType name="Vendor\Module\Model\Session\Storage"
             type="Magento\Framework\Session\Storage">
    <arguments>
        <argument name="namespace" xsi:type="string">vendor_module</argument>
    </arguments>
</virtualType>

<!-- Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ -->
<type name="Vendor\Module\Model\Session">
    <arguments>
        <argument name="storage" xsi:type="object">Vendor\Module\Model\Session\Storage</argument>
    </arguments>
</type>
```

### Ù…ØªÙ‰ ØªØ³ØªØ®Ø¯Ù…Ù‡ØŸ

1. **Ø¥Ø¹Ø§Ø¯Ø© ØªÙƒÙˆÙŠÙ†** class Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù€ arguments Ù…Ø®ØªÙ„ÙØ©
2. **ØªØ¬Ù†Ø¨** Ø¥Ù†Ø´Ø§Ø¡ PHP class Ø¬Ø¯ÙŠØ¯
3. **Logger** Ù…Ø®ØµØµ Ù„Ù…ÙˆØ¯ÙˆÙ„

### Virtual Logger

```xml
<!-- Logger Ù…Ø®ØµØµ Ù„Ù…ÙˆØ¯ÙˆÙ„Ùƒ -->
<virtualType name="Vendor\Module\Logger\Handler"
             type="Magento\Framework\Logger\Handler\Base">
    <arguments>
        <argument name="fileName" xsi:type="string">/var/log/vendor_module.log</argument>
    </arguments>
</virtualType>

<virtualType name="Vendor\Module\Logger\Logger"
             type="Magento\Framework\Logger\Monolog">
    <arguments>
        <argument name="name" xsi:type="string">vendor_module</argument>
        <argument name="handlers" xsi:type="array">
            <item name="system" xsi:type="object">Vendor\Module\Logger\Handler</item>
        </argument>
    </arguments>
</virtualType>

<!-- Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ -->
<type name="Vendor\Module\Model\MyClass">
    <arguments>
        <argument name="logger" xsi:type="object">Vendor\Module\Logger\Logger</argument>
    </arguments>
</type>
```

---

## 7. Arguments

### Shared Argument

```xml
<!-- shared="true" (default) - Singleton -->
<argument name="obj" xsi:type="object">Vendor\Module\Model\Item</argument>

<!-- shared="false" - New instance ÙƒÙ„ Ù…Ø±Ø© -->
<argument name="obj" xsi:type="object" shared="false">Vendor\Module\Model\Item</argument>
```

### Sort Order

```xml
<argument name="processors" xsi:type="array">
    <item name="first" xsi:type="object" sortOrder="10">First\Processor</item>
    <item name="second" xsi:type="object" sortOrder="20">Second\Processor</item>
    <item name="third" xsi:type="object" sortOrder="30">Third\Processor</item>
</argument>
```

### Disable Item

```xml
<!-- Ø­Ø°Ù item Ù…Ù† array ÙÙŠ Ù…ÙˆØ¯ÙˆÙ„ Ø¢Ø®Ø± -->
<type name="Some\Class">
    <arguments>
        <argument name="handlers" xsi:type="array">
            <item name="unwanted" xsi:type="null"/>
        </argument>
    </arguments>
</type>
```

---

## 8. Plugins

### ØªØ¹Ø±ÙŠÙ Plugin

```xml
<type name="Magento\Catalog\Model\Product">
    <plugin name="vendor_module_product_plugin"
            type="Vendor\Module\Plugin\ProductPlugin"
            sortOrder="10"
            disabled="false"/>
</type>
```

### Plugin Attributes

| Attribute | Ø§Ù„ÙˆØµÙ |
|-----------|-------|
| `name` | Ø§Ø³Ù… ÙØ±ÙŠØ¯ |
| `type` | Ø§Ù„Ù€ Plugin class |
| `sortOrder` | Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø£Ù‚Ù„ = Ø£ÙˆÙ„Ø§Ù‹) |
| `disabled` | ØªØ¹Ø·ÙŠÙ„ Plugin |

### Plugin Class

```php
<?php
declare(strict_types=1);

namespace Vendor\Module\Plugin;

use Magento\Catalog\Model\Product;

class ProductPlugin
{
    /**
     * Before method
     */
    public function beforeGetName(Product $subject): array
    {
        // ØªØ¹Ø¯ÙŠÙ„ arguments Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°
        return [];  // Return array of arguments
    }

    /**
     * After method
     */
    public function afterGetName(Product $subject, string $result): string
    {
        // ØªØ¹Ø¯ÙŠÙ„ result Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†ÙÙŠØ°
        return $result . ' - Modified';
    }

    /**
     * Around method (Ø§Ù„Ø£Ù‚ÙˆÙ‰)
     */
    public function aroundGetName(Product $subject, callable $proceed): string
    {
        // Ù‚Ø¨Ù„
        $result = $proceed();  // ØªÙ†ÙÙŠØ° Ø§Ù„Ù€ original method
        // Ø¨Ø¹Ø¯
        return $result;
    }
}
```

---

## 9. Factories

### Ù…Ø§ Ù‡Ùˆ FactoryØŸ

ÙŠÙÙ†Ø´Ø¦ **instances Ø¬Ø¯ÙŠØ¯Ø©** Ù…Ù† class.

```php
// Factory ÙŠÙÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
Vendor\Module\Model\EntityFactory

// ÙŠÙØ³ØªØ®Ø¯Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ instances Ø¬Ø¯ÙŠØ¯Ø©
$entity = $this->entityFactory->create();
```

### ØªØ¹Ø±ÙŠÙ Factory

```xml
<!-- Ù„Ø§ ØªØ­ØªØ§Ø¬ ØªØ¹Ø±ÙŠÙ - ÙŠÙÙˆÙ„Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ -->
<!-- Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ†Ùƒ override: -->
<type name="Vendor\Module\Model\EntityFactory">
    <arguments>
        <argument name="instanceName" xsi:type="string">Vendor\Module\Model\CustomEntity</argument>
    </arguments>
</type>
```

### Ø§Ø³ØªØ®Ø¯Ø§Ù… Factory

```php
class MyService
{
    public function __construct(
        private \Vendor\Module\Model\EntityFactory $entityFactory
    ) {}

    public function createEntity(array $data): Entity
    {
        $entity = $this->entityFactory->create();  // new instance
        $entity->setData($data);
        return $entity;
    }
}
```

---

## 10. Proxies

### Ù…Ø§ Ù‡Ùˆ ProxyØŸ

**Lazy loading** Ù„Ù„Ù€ dependencies Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©.

```php
// Ø¨Ø¯ÙˆÙ† Proxy - ÙŠÙØ­Ù…Ù„ ÙÙˆØ±Ø§Ù‹
public function __construct(HeavyClass $heavy) {}

// Ù…Ø¹ Proxy - ÙŠÙØ­Ù…Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙ‚Ø·
public function __construct(HeavyClass\Proxy $heavy) {}
```

### ØªØ¹Ø±ÙŠÙ Proxy

```xml
<type name="Vendor\Module\Model\MyClass">
    <arguments>
        <argument name="session" xsi:type="object">Magento\Customer\Model\Session\Proxy</argument>
    </arguments>
</type>
```

### Ù…ØªÙ‰ ØªØ³ØªØ®Ø¯Ù…Ù‡ØŸ

1. **CLI commands** - Session Ù„Ø§ ÙŠÙØ³ØªØ®Ø¯Ù… ØºØ§Ù„Ø¨Ø§Ù‹
2. **Cron jobs** - ØªØ­Ù…ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ø¬Ø©
3. **Heavy dependencies** - Database connections

---

## 11. Best Practices

### âœ… 1. Ø§Ø³ØªØ®Ø¯Ù… Interfaces

```xml
<!-- âœ… ØµØ­ÙŠØ­ -->
<preference for="Vendor\Module\Api\ServiceInterface"
            type="Vendor\Module\Model\Service"/>

<!-- âŒ Ø®Ø·Ø£ - concrete class Ù…Ø¨Ø§Ø´Ø±Ø© -->
public function __construct(Vendor\Module\Model\Service $service) {}
```

### âœ… 2. Ø§Ø³ØªØ®Ø¯Ù… Plugins Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Preferences

```xml
<!-- âœ… Ø£ÙØ¶Ù„ - Ù„Ø§ ÙŠØ³ØªØ¨Ø¯Ù„ Ø§Ù„Ù€ class -->
<type name="Magento\Catalog\Model\Product">
    <plugin name="my_plugin" type="Vendor\Module\Plugin\ProductPlugin"/>
</type>

<!-- âŒ Ø®Ø·ÙŠØ± - ÙŠØ³ØªØ¨Ø¯Ù„ ÙƒÙ„ÙŠØ§Ù‹ -->
<preference for="Magento\Catalog\Model\Product"
            type="Vendor\Module\Model\Product"/>
```

### âœ… 3. Ø§Ø³ØªØ®Ø¯Ù… Area-specific di.xml

```
etc/frontend/di.xml  â† Ù„Ù„Ù€ frontend ÙÙ‚Ø·
etc/adminhtml/di.xml â† Ù„Ù„Ù€ admin ÙÙ‚Ø·
```

### âœ… 4. Ø§Ø³ØªØ®Ø¯Ù… Virtual Types Ù„Ù„Ù€ Loggers

```xml
<virtualType name="MyLogger" type="Magento\Framework\Logger\Monolog">
    <arguments>
        <argument name="name" xsi:type="string">my_module</argument>
    </arguments>
</virtualType>
```

---

## 12. Ù…Ø³ØªÙˆÙ‰ Ù…ØªÙ‚Ø¯Ù…

### Compile DI

```bash
# ÙŠØ¬Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ø¹Ø¯ ØªØ¹Ø¯ÙŠÙ„ di.xml
bin/magento setup:di:compile
```

### Generated Classes

```
generated/code/
â”œâ”€â”€ Vendor/
â”‚   â””â”€â”€ Module/
â”‚       â””â”€â”€ Model/
â”‚           â”œâ”€â”€ EntityFactory.php        # Factory
â”‚           â”œâ”€â”€ Entity/
â”‚           â”‚   â””â”€â”€ Proxy.php            # Proxy
â”‚           â””â”€â”€ EntityInterceptor.php    # Plugin Interceptor
```

### Sensitive Arguments

```xml
<type name="Vendor\Module\Model\ApiClient">
    <arguments>
        <argument name="apiKey" xsi:type="string">
            <!-- Ù…Ù† env variable -->
            ${VENDOR_API_KEY}
        </argument>
    </arguments>
</type>
```

### Constructor Promotion (PHP 8+)

```php
class MyClass
{
    public function __construct(
        private readonly LoggerInterface $logger,
        private readonly EntityFactory $entityFactory,
        private array $data = []
    ) {}
}
```

---

## ğŸ“Œ Ù…Ù„Ø®Øµ

| Ø§Ù„Ø¹Ù†ØµØ± | Ø§Ù„ÙˆØ¸ÙŠÙØ© |
|--------|---------|
| `<preference>` | Interface â†’ Implementation |
| `<type>` | ØªÙƒÙˆÙŠÙ† Class arguments |
| `<virtualType>` | Class ÙˆÙ‡Ù…ÙŠ |
| `<plugin>` | Before/After/Around methods |

---

## â¬…ï¸ [Ø§Ù„Ø³Ø§Ø¨Ù‚](./07_VIEWS.md) | [ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©](../MODULE_STRUCTURE.md) | [Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸](./09_OBSERVERS.md)
